<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>LoRaWAN: DataServer Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">LoRaWAN
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('class_lora_1_1_data_server.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pub-static-methods">Static Public Member Functions</a> &#124;
<a href="#pub-attribs">Data Fields</a> &#124;
<a href="#pri-methods">Private Member Functions</a> &#124;
<a href="#pri-attribs">Private Attributes</a> &#124;
<a href="#pri-static-attribs">Static Private Attributes</a>  </div>
  <div class="headertitle">
<div class="title">DataServer Class Reference</div>  </div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:af8fa59992209e36dccb3eefb0f75531f"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_lora_1_1_data_server.html#af8fa59992209e36dccb3eefb0f75531f">start</a> ()</td></tr>
<tr class="separator:af8fa59992209e36dccb3eefb0f75531f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acf279a7b53dd92327b68f3b3f376ee2f"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_lora_1_1_data_server.html#acf279a7b53dd92327b68f3b3f376ee2f">process</a> (string $topic, string $msg)</td></tr>
<tr class="separator:acf279a7b53dd92327b68f3b3f376ee2f"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-static-methods"></a>
Static Public Member Functions</h2></td></tr>
<tr class="memitem:a0deb004950b8dc4f51836316fd19c111"><td class="memItemLeft" align="right" valign="top"><a id="a0deb004950b8dc4f51836316fd19c111"></a>
static&#160;</td><td class="memItemRight" valign="bottom"><b>instance</b> ()</td></tr>
<tr class="separator:a0deb004950b8dc4f51836316fd19c111"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4b928f64ca70f6b6d9bb388bc943ff3f"><td class="memItemLeft" align="right" valign="top">static&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_lora_1_1_data_server.html#a4b928f64ca70f6b6d9bb388bc943ff3f">processMessage</a> ($topic, $msg)</td></tr>
<tr class="separator:a4b928f64ca70f6b6d9bb388bc943ff3f"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-attribs"></a>
Data Fields</h2></td></tr>
<tr class="memitem:af213a81daaf386c089bb36f148cfbd96"><td class="memItemLeft" align="right" valign="top"><a id="af213a81daaf386c089bb36f148cfbd96"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>$rt_client</b> = null</td></tr>
<tr class="separator:af213a81daaf386c089bb36f148cfbd96"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a721b31e1995c24214da0e89eb5ec3100"><td class="memItemLeft" align="right" valign="top"><a id="a721b31e1995c24214da0e89eb5ec3100"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>$rt_address</b> = ''</td></tr>
<tr class="separator:a721b31e1995c24214da0e89eb5ec3100"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aaf8416d215d1e9710dfe026490c998dc"><td class="memItemLeft" align="right" valign="top"><a id="aaf8416d215d1e9710dfe026490c998dc"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>$allowPrint</b> = true</td></tr>
<tr class="separator:aaf8416d215d1e9710dfe026490c998dc"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pri-methods"></a>
Private Member Functions</h2></td></tr>
<tr class="memitem:a883eaf25eb21a0ba827bb9a9a3593861"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_lora_1_1_data_server.html#a883eaf25eb21a0ba827bb9a9a3593861">broadcast</a> (array $msg, array &amp;$messages)</td></tr>
<tr class="separator:a883eaf25eb21a0ba827bb9a9a3593861"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afc5d093aad072fb26010dc33782491e1"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_lora_1_1_data_server.html#afc5d093aad072fb26010dc33782491e1">parseReceived</a> (string $topic, string $msg, array &amp;$parsedTopic, array &amp;$parsedMsg)</td></tr>
<tr class="separator:afc5d093aad072fb26010dc33782491e1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5443eb6d2b44355a72718463885b4631"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_lora_1_1_data_server.html#a5443eb6d2b44355a72718463885b4631">parseTopic</a> (string $topic)</td></tr>
<tr class="separator:a5443eb6d2b44355a72718463885b4631"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac16e17dca8edf6daf34e403654f9c2c2"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_lora_1_1_data_server.html#ac16e17dca8edf6daf34e403654f9c2c2">parseMessage</a> (\<a class="el" href="class_request_data.html">RequestData</a> $req)</td></tr>
<tr class="separator:ac16e17dca8edf6daf34e403654f9c2c2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a48fb1fc7a81a6cf12d17e919e7d724c0"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_lora_1_1_data_server.html#a48fb1fc7a81a6cf12d17e919e7d724c0">parseActivation</a> (\<a class="el" href="class_request_data.html">RequestData</a> $req)</td></tr>
<tr class="separator:a48fb1fc7a81a6cf12d17e919e7d724c0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a67382ebb6b28ebe3ad81d2f0ae541a84"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_lora_1_1_data_server.html#a67382ebb6b28ebe3ad81d2f0ae541a84">parsePayload</a> (string $payload)</td></tr>
<tr class="separator:a67382ebb6b28ebe3ad81d2f0ae541a84"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa22496921de05f8626d82a7530fcc517"><td class="memItemLeft" align="right" valign="top"><a id="aa22496921de05f8626d82a7530fcc517"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>rtConnect</b> ()</td></tr>
<tr class="separator:aa22496921de05f8626d82a7530fcc517"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af355edd34f94d0643a98664a966a9658"><td class="memItemLeft" align="right" valign="top"><a id="af355edd34f94d0643a98664a966a9658"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>MQTTConnect</b> ()</td></tr>
<tr class="separator:af355edd34f94d0643a98664a966a9658"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6502357e2b91bc3e73f34ec4233b60d3"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_lora_1_1_data_server.html#a6502357e2b91bc3e73f34ec4233b60d3">insert</a> (string $deviceId, array $data)</td></tr>
<tr class="separator:a6502357e2b91bc3e73f34ec4233b60d3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae86e92ed03b6395cfc4cb99e2371e14a"><td class="memItemLeft" align="right" valign="top"><a id="ae86e92ed03b6395cfc4cb99e2371e14a"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>print</b> ($msg, $eol=true)</td></tr>
<tr class="separator:ae86e92ed03b6395cfc4cb99e2371e14a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aca780669b9640bfb9f17dcbb11e592d1"><td class="memItemLeft" align="right" valign="top"><a id="aca780669b9640bfb9f17dcbb11e592d1"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>printAll</b> (array $msgs)</td></tr>
<tr class="separator:aca780669b9640bfb9f17dcbb11e592d1"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pri-attribs"></a>
Private Attributes</h2></td></tr>
<tr class="memitem:a5946274cba635d6d4e49d93b66aa1964"><td class="memItemLeft" align="right" valign="top"><a id="a5946274cba635d6d4e49d93b66aa1964"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>$mqtt_client</b> = null</td></tr>
<tr class="separator:a5946274cba635d6d4e49d93b66aa1964"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pri-static-attribs"></a>
Static Private Attributes</h2></td></tr>
<tr class="memitem:ad9d7ce33ebb142b70e58b68052ca0ea8"><td class="memItemLeft" align="right" valign="top"><a id="ad9d7ce33ebb142b70e58b68052ca0ea8"></a>
static&#160;</td><td class="memItemRight" valign="bottom"><b>$instance</b></td></tr>
<tr class="separator:ad9d7ce33ebb142b70e58b68052ca0ea8"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>TODO: Maybe add a buffer for failed broadcasts so that they can be sent later on again. A singleton based class for managing MQTT connection to The Things Network and broadcasting data to the system. </p>
</div><h2 class="groupheader">Member Function Documentation</h2>
<a id="a883eaf25eb21a0ba827bb9a9a3593861"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a883eaf25eb21a0ba827bb9a9a3593861">&#9670;&nbsp;</a></span>broadcast()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">broadcast </td>
          <td>(</td>
          <td class="paramtype">array&#160;</td>
          <td class="paramname"><em>$msg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">array &amp;&#160;</td>
          <td class="paramname"><em>$messages</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000006">Todo:</a></b></dt><dd>Internal message processing (terminate). Broadcasts a received message to other server systems. Only interested one at the moment is the realtime sever which in turn broadcasts it onwards to clients who are interested in it. </dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">$msg</td><td>Parsed MQTT message payload with device id and time stamp. </td></tr>
    <tr><td class="paramname">$messages</td><td>Messages array to allow this method add messages about the data processing. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Returns true if the data was succesfully broadcasted and false if not. </dd></dl>
<div class="fragment"><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;                                                              : <span class="keywordtype">bool</span> {</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;        <span class="keywordflow">if</span> (!$this-&gt;rt_client) {</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;            $messages [] = <span class="stringliteral">&quot;Establishing realtime server connection; {$this-&gt;rt_address}&quot;</span>;</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;            <span class="keywordflow">if</span> (!$this-&gt;rtConnect ()) {</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;                $messages [] = <span class="stringliteral">&quot;Could not establish realtime connection.&quot;</span>;</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;            }</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;            $messages [] = <span class="stringliteral">&quot;Realtime connection established.&quot;</span>;</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;        }</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;        $messages [] = <span class="stringliteral">&quot;Broadcasting data.&quot;</span>;</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;        $data = <a class="code" href="class_internal_m_s_g.html#ae3b91a7baffc1bef8eaeb4a5bcca65f0">InternalMSG::composeMsg</a> (<a class="code" href="class_lora_1_1_server_1_1_command.html#a59322b745f918a8b5f747b08d9d5ddec">Command::DATA</a>, $msg);</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;        <span class="keywordflow">if</span> (!$this-&gt;rt_client-&gt;send ($data)) {</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;            <span class="keywordflow">if</span> (!$this-&gt;rt_client-&gt;isConnected ()) {</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;                $messages [] = <span class="stringliteral">&quot;Realtime client connection error: &quot;</span>.$this-&gt;rt_client-&gt;lastError ();</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;            }</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;        }</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;        $this-&gt;rt_client-&gt;receive ($response);</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;        <span class="keywordflow">if</span> ($response === <span class="stringliteral">&#39;terminate&#39;</span>) {</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;            $this-&gt;rt_client-&gt;close ();</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;        }</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;        $messages [] = <span class="stringliteral">&quot;Response: ${response}&quot;</span>;</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    }</div><div class="ttc" id="class_internal_m_s_g_html_ae3b91a7baffc1bef8eaeb4a5bcca65f0"><div class="ttname"><a href="class_internal_m_s_g.html#ae3b91a7baffc1bef8eaeb4a5bcca65f0">InternalMSG\composeMsg</a></div><div class="ttdeci">static composeMsg(int $command, array $message)</div><div class="ttdef"><b>Definition:</b> internalmsg.php:17</div></div>
<div class="ttc" id="class_lora_1_1_server_1_1_command_html_a59322b745f918a8b5f747b08d9d5ddec"><div class="ttname"><a href="class_lora_1_1_server_1_1_command.html#a59322b745f918a8b5f747b08d9d5ddec">Lora\Server\Command\DATA</a></div><div class="ttdeci">const DATA</div><div class="ttdoc">Data message containing data. </div><div class="ttdef"><b>Definition:</b> command.php:11</div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="class_lora_1_1_data_server_a883eaf25eb21a0ba827bb9a9a3593861_cgraph.png" border="0" usemap="#class_lora_1_1_data_server_a883eaf25eb21a0ba827bb9a9a3593861_cgraph" alt=""/></div>
<map name="class_lora_1_1_data_server_a883eaf25eb21a0ba827bb9a9a3593861_cgraph" id="class_lora_1_1_data_server_a883eaf25eb21a0ba827bb9a9a3593861_cgraph">
<area shape="rect" id="node2" href="class_internal_m_s_g.html#ae3b91a7baffc1bef8eaeb4a5bcca65f0" title="InternalMSG\\composeMsg" alt="" coords="132,5,308,32"/>
</map>
</div>

</div>
</div>
<a id="a6502357e2b91bc3e73f34ec4233b60d3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6502357e2b91bc3e73f34ec4233b60d3">&#9670;&nbsp;</a></span>insert()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">insert </td>
          <td>(</td>
          <td class="paramtype">string&#160;</td>
          <td class="paramname"><em>$deviceId</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">array&#160;</td>
          <td class="paramname"><em>$data</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>A context aware method for inserting data into database. Checks for the presence of certain values in $data and uses that information to determine if data should be inserted or not. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">$deviceId</td><td>Device hardware id. </td></tr>
    <tr><td class="paramname">$data</td><td>An array containing parsed MQTT originated data. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Returns true on success and false if an erro occured. </dd></dl>
<div class="fragment"><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;                                                            : <span class="keywordtype">bool</span> {</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;        $result = <a class="code" href="class_lora_1_1_d_a_o.html#ad231d647bc7bf221289e5e52254d3743">DAO::insertDevice</a> ($deviceId);</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;        <span class="keywordflow">if</span> (isset ($data [<span class="stringliteral">&#39;msg&#39;</span>])) {</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;            $result &amp;= <a class="code" href="class_lora_1_1_d_a_o.html#aa6d166466386cc6a0147d00719444276">DAO::insertRaw</a> ($data);</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;        }</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;        <span class="keywordflow">if</span> (isset ($data [<span class="stringliteral">&#39;msg&#39;</span>][<span class="stringliteral">&#39;payload&#39;</span>], $data [<span class="stringliteral">&#39;msg&#39;</span>][<span class="stringliteral">&#39;time&#39;</span>])) {</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;            $result &amp;= <a class="code" href="class_lora_1_1_d_a_o.html#ae6bdc6374713a2785aed2fb29c49ca31">DAO::insertMeasurement</a> ($deviceId, $data [<span class="stringliteral">&#39;msg&#39;</span>][<span class="stringliteral">&#39;time&#39;</span>], $data [<span class="stringliteral">&#39;msg&#39;</span>][<span class="stringliteral">&#39;payload&#39;</span>]);</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;        }</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;        <span class="keywordflow">return</span> $result;</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;    }</div><div class="ttc" id="class_lora_1_1_d_a_o_html_ae6bdc6374713a2785aed2fb29c49ca31"><div class="ttname"><a href="class_lora_1_1_d_a_o.html#ae6bdc6374713a2785aed2fb29c49ca31">Lora\DAO\insertMeasurement</a></div><div class="ttdeci">static insertMeasurement(string $device_id, int $time, array $measurements)</div><div class="ttdef"><b>Definition:</b> dao.php:55</div></div>
<div class="ttc" id="class_lora_1_1_d_a_o_html_ad231d647bc7bf221289e5e52254d3743"><div class="ttname"><a href="class_lora_1_1_d_a_o.html#ad231d647bc7bf221289e5e52254d3743">Lora\DAO\insertDevice</a></div><div class="ttdeci">static insertDevice(string $device)</div><div class="ttdef"><b>Definition:</b> dao.php:72</div></div>
<div class="ttc" id="class_lora_1_1_d_a_o_html_aa6d166466386cc6a0147d00719444276"><div class="ttname"><a href="class_lora_1_1_d_a_o.html#aa6d166466386cc6a0147d00719444276">Lora\DAO\insertRaw</a></div><div class="ttdeci">static insertRaw(array $raw)</div><div class="ttdef"><b>Definition:</b> dao.php:88</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a48fb1fc7a81a6cf12d17e919e7d724c0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a48fb1fc7a81a6cf12d17e919e7d724c0">&#9670;&nbsp;</a></span>parseActivation()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">parseActivation </td>
          <td>(</td>
          <td class="paramtype">\<a class="el" href="class_request_data.html">RequestData</a>&#160;</td>
          <td class="paramname"><em>$req</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>A case specific parser for an activation message. <a class="el" href="class_lora_1_1_data_server.html#ac16e17dca8edf6daf34e403654f9c2c2">DataServer::parseMessage</a> cannot parse this without unreasonably large changes so it is wrapped as its own function. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">$req</td><td>An instance of <a class="el" href="class_request_data.html">RequestData</a> wrapping the MQTT message. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Returns a nullable array. An array of parsed data is returned on success and null if the message cannot be parsed. </dd></dl>
<div class="fragment"><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;                                                         : ?array {</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;        $required = [</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;            <span class="stringliteral">&#39;dev_eui&#39;</span></div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;        ];</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;        $hwId = $req-&gt;getString (<span class="stringliteral">&#39;dev_eui&#39;</span>, <span class="stringliteral">&#39;&#39;</span>);</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;        <span class="keywordflow">if</span> (!$req-&gt;has ($required) || !DataLib::isHexString ($hwId)) {</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;            <span class="keywordflow">return</span> null;</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;        }</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;        <span class="keywordflow">return</span> [ <span class="stringliteral">&#39;device&#39;</span> =&gt; [ <span class="stringliteral">&#39;_id&#39;</span> =&gt; $hwId ] ];</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    }</div></div><!-- fragment -->
</div>
</div>
<a id="ac16e17dca8edf6daf34e403654f9c2c2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac16e17dca8edf6daf34e403654f9c2c2">&#9670;&nbsp;</a></span>parseMessage()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">parseMessage </td>
          <td>(</td>
          <td class="paramtype">\<a class="el" href="class_request_data.html">RequestData</a>&#160;</td>
          <td class="paramname"><em>$req</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Parses the MQTT messaage and ensures precense of required value as well as their type correctness. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">$req</td><td>An instance of <a class="el" href="class_request_data.html">RequestData</a> wrapping the MQTT message. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Returns a nullable array. An array of parsed data is returned on success and null if the message cannot be parsed. </dd></dl>
<div class="fragment"><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;                                                      : ?array {</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;        $required = [</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;            <span class="stringliteral">&#39;metadata&#39;</span>,</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;            <span class="stringliteral">&#39;dev_id&#39;</span>,</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;            <span class="stringliteral">&#39;hardware_serial&#39;</span>,</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;            <span class="stringliteral">&#39;payload_raw&#39;</span></div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;        ];</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;        $requiredMeta = [</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;            <span class="stringliteral">&#39;time&#39;</span></div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;        ];</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;        <span class="keywordflow">if</span> (!$req-&gt;has ($required)) {</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;            <span class="keywordflow">return</span> $this-&gt;<a class="code" href="class_lora_1_1_data_server.html#a48fb1fc7a81a6cf12d17e919e7d724c0">parseActivation</a> ($data);</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;        }</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;        <span class="keywordflow">if</span> ($req-&gt;readArray (<span class="stringliteral">&#39;metadata&#39;</span>, $meta)) {</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;            <span class="keywordflow">return</span> null;</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;        }</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;        $meta = <span class="keyword">new</span> <a class="code" href="namespace_request_data.html">RequestData</a> ($meta);</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;        <span class="keywordflow">if</span> (!$meta-&gt;has ($requiredMeta)) {</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;            <span class="keywordflow">return</span> null;</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;        }</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;        $req-&gt;readString (<span class="stringliteral">&#39;dev_id&#39;</span>, $devId, <span class="stringliteral">&#39;&#39;</span>);</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;        $req-&gt;readString (<span class="stringliteral">&#39;hardware_serial&#39;</span>, $hwId, <span class="stringliteral">&#39;&#39;</span>);</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;        $payload = $this-&gt;<a class="code" href="class_lora_1_1_data_server.html#a67382ebb6b28ebe3ad81d2f0ae541a84">parsePayload</a> ($req-&gt;getString (<span class="stringliteral">&#39;payload_raw&#39;</span>, <span class="stringliteral">&#39;&#39;</span>));</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;        $datetime = DateTime::createFromFormat (<span class="stringliteral">&#39;Y-m-d\TH:i:s+&#39;</span>, $meta-&gt;getString (<span class="stringliteral">&#39;time&#39;</span>, <span class="stringliteral">&#39;&#39;</span>));</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;        <span class="keywordflow">if</span> ($datetime === <span class="keyword">false</span> || $payload === null || !DataLib::isHexString ($hwId)) {</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;            <span class="keywordflow">return</span> null;</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;        }</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;        $result = [</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;            <span class="stringliteral">&#39;device&#39;</span> =&gt; [</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;                <span class="stringliteral">&#39;_id&#39;</span>               =&gt; $hwId,</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;                <span class="stringliteral">&#39;dev_id&#39;</span>            =&gt; $devId,</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;                <span class="stringliteral">&#39;hardware_serial&#39;</span>   =&gt; $hwId</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;            ],</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;            <span class="stringliteral">&#39;msg&#39;</span> =&gt; [</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;                <span class="stringliteral">&#39;device_id&#39;</span>         =&gt; $hwId,</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;                <span class="stringliteral">&#39;time&#39;</span>              =&gt; $datatime-&gt;getTimestamp (),</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;                <span class="stringliteral">&#39;payload&#39;</span>           =&gt; $payload</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;            ]</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;        ];</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;        <span class="keywordflow">return</span> $result;</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    }</div><div class="ttc" id="namespace_request_data_html"><div class="ttname"><a href="namespace_request_data.html">RequestData</a></div></div>
<div class="ttc" id="class_lora_1_1_data_server_html_a67382ebb6b28ebe3ad81d2f0ae541a84"><div class="ttname"><a href="class_lora_1_1_data_server.html#a67382ebb6b28ebe3ad81d2f0ae541a84">Lora\DataServer\parsePayload</a></div><div class="ttdeci">parsePayload(string $payload)</div><div class="ttdef"><b>Definition:</b> dataserver.php:237</div></div>
<div class="ttc" id="class_lora_1_1_data_server_html_a48fb1fc7a81a6cf12d17e919e7d724c0"><div class="ttname"><a href="class_lora_1_1_data_server.html#a48fb1fc7a81a6cf12d17e919e7d724c0">Lora\DataServer\parseActivation</a></div><div class="ttdeci">parseActivation(\RequestData $req)</div><div class="ttdef"><b>Definition:</b> dataserver.php:220</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a67382ebb6b28ebe3ad81d2f0ae541a84"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a67382ebb6b28ebe3ad81d2f0ae541a84">&#9670;&nbsp;</a></span>parsePayload()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">parsePayload </td>
          <td>(</td>
          <td class="paramtype">string&#160;</td>
          <td class="paramname"><em>$payload</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>A method to parse the raw payload data from the MQTT server. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">$payload</td><td>Raw payload string in base64 encoded form. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Returns null on failure and an array of associative arrays containing type value pairs of the measured values. </dd></dl>
<div class="fragment"><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;                                                    : ?array {</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;        <span class="keywordflow">if</span> (($payload = base64_decode ($payload)) === <span class="keyword">false</span>) {</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;            <span class="keywordflow">return</span> null;</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;        }</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;        $data = explode (<span class="charliteral">&#39;|&#39;</span>, $payload);</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;        $result = [];</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;        <span class="keywordflow">foreach</span> ($data as $key =&gt; $entry) {</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;            <span class="keywordflow">if</span> (empty ($entry)) {</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;                unset ($data [$key]);</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;                <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;            }</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;            $type = substr ($entry, 0, 3);</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;            $value = substr ($entry, 3);</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;            $result [] = [ $type =&gt; floatval ($value) ];</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;        }</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;        <span class="keywordflow">return</span> $result;</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;    }</div></div><!-- fragment -->
</div>
</div>
<a id="afc5d093aad072fb26010dc33782491e1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afc5d093aad072fb26010dc33782491e1">&#9670;&nbsp;</a></span>parseReceived()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">parseReceived </td>
          <td>(</td>
          <td class="paramtype">string&#160;</td>
          <td class="paramname"><em>$topic</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">string&#160;</td>
          <td class="paramname"><em>$msg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">array &amp;&#160;</td>
          <td class="paramname"><em>$parsedTopic</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">array &amp;&#160;</td>
          <td class="paramname"><em>$parsedMsg</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Parses the topic and message received from the MQTT server into more flexible form for this class to use. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir"></td><td class="paramname">$topic</td><td>Topic received from the MQTT server. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">$msg</td><td>Message receieved from the MQTT server. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">$parsedTopic</td><td>An array to which the parsed topic data will be set. Set to null if it cannot be parsed. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">$parsedMsg</td><td>An array to which the parsed message data will be set. Set to null if it cannot be parsed. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Returns true if parsing was succesful and false if not. </dd></dl>
<div class="fragment"><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;                                                                                                        : <span class="keywordtype">bool</span> {</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;        $msg = json_decode ($msg, <span class="keyword">true</span>);</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;        $parsedTopic = $this-&gt;<a class="code" href="class_lora_1_1_data_server.html#a5443eb6d2b44355a72718463885b4631">parseTopic</a> ($topic);</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;        $parsedMsg = $this-&gt;<a class="code" href="class_lora_1_1_data_server.html#ac16e17dca8edf6daf34e403654f9c2c2">parseMessage</a> (<span class="keyword">new</span> \<a class="code" href="namespace_request_data.html">RequestData</a> ($msg));</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;        <span class="keywordflow">return</span> $parsedTopic !== null &amp;&amp; $parsedMsg !== null;</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;    }</div><div class="ttc" id="class_lora_1_1_data_server_html_ac16e17dca8edf6daf34e403654f9c2c2"><div class="ttname"><a href="class_lora_1_1_data_server.html#ac16e17dca8edf6daf34e403654f9c2c2">Lora\DataServer\parseMessage</a></div><div class="ttdeci">parseMessage(\RequestData $req)</div><div class="ttdef"><b>Definition:</b> dataserver.php:171</div></div>
<div class="ttc" id="namespace_request_data_html"><div class="ttname"><a href="namespace_request_data.html">RequestData</a></div></div>
<div class="ttc" id="class_lora_1_1_data_server_html_a5443eb6d2b44355a72718463885b4631"><div class="ttname"><a href="class_lora_1_1_data_server.html#a5443eb6d2b44355a72718463885b4631">Lora\DataServer\parseTopic</a></div><div class="ttdeci">parseTopic(string $topic)</div><div class="ttdef"><b>Definition:</b> dataserver.php:146</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a5443eb6d2b44355a72718463885b4631"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5443eb6d2b44355a72718463885b4631">&#9670;&nbsp;</a></span>parseTopic()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">parseTopic </td>
          <td>(</td>
          <td class="paramtype">string&#160;</td>
          <td class="paramname"><em>$topic</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Parses MQTT topic string into an associative array. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">$topic</td><td>An MQTT topic. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Returns an associative array containing the topic information. </dd></dl>
<div class="fragment"><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;                                                : array {</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;        $topic = explode (<span class="charliteral">&#39;/&#39;</span>, $topic);</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        $keys = [</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;            <span class="stringliteral">&#39;application&#39;</span>,</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;            <span class="stringliteral">&#39;source&#39;</span>,</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;            <span class="stringliteral">&#39;device&#39;</span>,</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;            <span class="stringliteral">&#39;message&#39;</span>,</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;            <span class="stringliteral">&#39;event&#39;</span></div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;        ];</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;        <span class="keywordflow">foreach</span> ($topic as $key =&gt; $value) {</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;            <span class="keywordflow">if</span> (!isset ($keys [$key])) {</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;                <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;            }</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;            $topic [$keys [$key]] = $value;</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;            unset ($topic [$key]);</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;        }</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;        <span class="keywordflow">return</span> $topic;</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;    }</div></div><!-- fragment -->
</div>
</div>
<a id="acf279a7b53dd92327b68f3b3f376ee2f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acf279a7b53dd92327b68f3b3f376ee2f">&#9670;&nbsp;</a></span>process()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">process </td>
          <td>(</td>
          <td class="paramtype">string&#160;</td>
          <td class="paramname"><em>$topic</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">string&#160;</td>
          <td class="paramname"><em>$msg</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Main processing method. Parses, stores and broadcasts the received data. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">$topic</td><td>Topic of the MQTT messagae. </td></tr>
    <tr><td class="paramname">$msg</td><td>Message received from the MQTT server. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>An array of messages is returned describing the processing of the message. </dd></dl>
<div class="fragment"><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;                                                         : array {</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;        $messages = [];</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;        $messages [] = <span class="stringliteral">&quot;Message received: &quot;</span>.date (<span class="stringliteral">&quot;r&quot;</span>).<span class="stringliteral">&quot;\nTopic:${topic}\n${msg}\n&quot;</span>;</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;        <span class="keywordflow">if</span> (!$this-&gt;<a class="code" href="class_lora_1_1_data_server.html#afc5d093aad072fb26010dc33782491e1">parseReceived</a> ($topic, $msg, $parsedTopic, $parsedMsg)) {</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;            $messages [] = <span class="stringliteral">&quot;Failed to parse message.&quot;</span>;</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;            <span class="keywordflow">return</span> $messages;</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;        }</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;        <span class="keywordflow">if</span> (strtolower ($parsedMsg [<span class="stringliteral">&#39;msg&#39;</span>][<span class="stringliteral">&#39;payload&#39;</span>]) === <span class="stringliteral">&#39;heartbeat&#39;</span>) {</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;            <span class="keywordflow">return</span> $messages;</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;        }</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;        $parsedMsg [<span class="stringliteral">&#39;topic&#39;</span>] = $parsedTopic;</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;        $this-&gt;<a class="code" href="class_lora_1_1_data_server.html#a6502357e2b91bc3e73f34ec4233b60d3">insert</a> ($parsedMsg [<span class="stringliteral">&#39;device&#39;</span>][<span class="stringliteral">&#39;_id&#39;</span>], $parsedMsg);</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;        $this-&gt;<a class="code" href="class_lora_1_1_data_server.html#a883eaf25eb21a0ba827bb9a9a3593861">broadcast</a> ($parsedMsg [<span class="stringliteral">&#39;msg&#39;</span>], $messages);</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;        <span class="keywordflow">return</span> $messages;</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;    }</div><div class="ttc" id="class_lora_1_1_data_server_html_a883eaf25eb21a0ba827bb9a9a3593861"><div class="ttname"><a href="class_lora_1_1_data_server.html#a883eaf25eb21a0ba827bb9a9a3593861">Lora\DataServer\broadcast</a></div><div class="ttdeci">broadcast(array $msg, array &amp;$messages)</div><div class="ttdef"><b>Definition:</b> dataserver.php:100</div></div>
<div class="ttc" id="class_lora_1_1_data_server_html_a6502357e2b91bc3e73f34ec4233b60d3"><div class="ttname"><a href="class_lora_1_1_data_server.html#a6502357e2b91bc3e73f34ec4233b60d3">Lora\DataServer\insert</a></div><div class="ttdeci">insert(string $deviceId, array $data)</div><div class="ttdef"><b>Definition:</b> dataserver.php:279</div></div>
<div class="ttc" id="class_lora_1_1_data_server_html_afc5d093aad072fb26010dc33782491e1"><div class="ttname"><a href="class_lora_1_1_data_server.html#afc5d093aad072fb26010dc33782491e1">Lora\DataServer\parseReceived</a></div><div class="ttdeci">parseReceived(string $topic, string $msg, array &amp;$parsedTopic, array &amp;$parsedMsg)</div><div class="ttdef"><b>Definition:</b> dataserver.php:134</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a4b928f64ca70f6b6d9bb388bc943ff3f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4b928f64ca70f6b6d9bb388bc943ff3f">&#9670;&nbsp;</a></span>processMessage()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static processMessage </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>$topic</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>$msg</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>A static entry point to message processing routine. Performs primitive validity checks on data types to see if it is the data is even remotely processable. Proper data sanity checks are done later. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">$topic</td><td>Topic of the MQTT message. </td></tr>
    <tr><td class="paramname">$msg</td><td>Message received from the MQTT server. </td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;                                                         : <span class="keywordtype">void</span> {</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;        $temp = self::instance ();</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;        <span class="keywordflow">if</span> (!is_string ($topic) || !is_string ($msg) || !DataLib::isJson ($msg)) {</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;            $temp-&gt;print (<span class="stringliteral">&quot;Invalid message received.&quot;</span>);</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;            <span class="keywordflow">return</span>;</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;        }</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;        $messages = $temp-&gt;process ($topic, $msg);</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;        $temp-&gt;printAll ($messages);</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    }</div></div><!-- fragment -->
</div>
</div>
<a id="af8fa59992209e36dccb3eefb0f75531f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af8fa59992209e36dccb3eefb0f75531f">&#9670;&nbsp;</a></span>start()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">start </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Start the server loop. This is a blocking wait function. </p>
<div class="fragment"><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;                             : <span class="keywordtype">void</span> {</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;        $this-&gt;print (<span class="stringliteral">&quot;Establishing TTN connection.&quot;</span>);</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;        <span class="keywordflow">if</span> (!$this-&gt;MQTTConnect ()) {</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;            $this-&gt;print (<span class="stringliteral">&quot;Could not establish connection to TTN.&quot;</span>);</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;            <span class="keywordflow">return</span>;</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;        }</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;        $this-&gt;print (<span class="stringliteral">&quot;Connection to TTN server established. Subscribing to channels...&quot;</span>);</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;        $topics [<span class="charliteral">&#39;#&#39;</span>] = [</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;            <span class="stringliteral">&quot;qos&quot;</span> =&gt; 0,</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;            <span class="stringliteral">&quot;function&quot;</span> =&gt; <span class="stringliteral">&quot;\Lora\DataServer::processMessage&quot;</span></div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;        ];</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;        $this-&gt;mqtt_client-&gt;subscribe ($topics);</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;        <span class="comment">// $this-&gt;mqtt_client-&gt;debug = true;</span></div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;        $this-&gt;print (<span class="stringliteral">&quot;Subscribing complete. Listening for messages.&quot;</span>.PHP_EOL);</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;        <span class="keywordflow">while</span> ($this-&gt;mqtt_client-&gt;proc ());</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;        $this-&gt;mqtt_client-&gt;close ();</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;        $this-&gt;rt_client-&gt;close ();</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;    }</div></div><!-- fragment -->
</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li>servers/mqttserver/server/dataserver.php</li>
</ul>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespace_lora.html">Lora</a></li><li class="navelem"><a class="el" href="class_lora_1_1_data_server.html">DataServer</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
